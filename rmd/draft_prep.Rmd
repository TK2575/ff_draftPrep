---
title: "Fantasy Football Draft Prep"
author: "Tom Kain"
date: "8/10/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(paste(getwd(), "_libraries.R", sep = "/"))
```

```{r constants}
# force re-pull of all data even if captured today
force <- FALSE
# TODO replace manual capture of last season's best/replacement values with api query
# TODO enhance predraft ranking scrape to not require selenium (ffanalytics::yahoo_draft())

season <- 2022
regular_season_games <- 17
budget <- 200

# average winning score in 2021, queried via tk_fantasy_sports repo
target_points_week <- 131.7 

# TODO derive this
# 2021 was 7.46 = 209 (budget) / (130 - manually computed replacement values from 2019 (~101.98))
dollar_vorp_target_override <- NULL

out <- here::here("out")
latest <- here::here(out, "latest")
last_year_replacement_diff_file <- here::here("in", "2021_replacement_diff.csv")

google_conf <- config::get(file = here::here("conf", "conf.yaml"))$google
google_sheet_url <- google_conf$gsheet_url
google_sheet_user <- google_conf$gsheet_user
```

```{r scrape_projections}
scrape <- 
  scrape_projections(season, out, latest, force)
```

```{r scrape_yahoo_auction_values}
yahoo_av <- 
  scrape_yahoo_auction_values(out, latest, force)
```

```{r dst_yardage_model}
predicted_yards_per_game <- 
  predict_def_yards_per_game(season, out, latest, force)
```

```{r projections_table}
projections_table <- 
  calculate_projections_table(out, latest, force)
```

```{r projections}
projections <-
  projections_table %>%
  filter(position != 'LB') %>% 
  select(id:position, avg_type:ceiling, tier:aav) %>% 
  group_by(id, first_name, last_name, team, position) %>% 
  summarize(points = mean(points) %>% round(),
            sd_pts = mean(sd_pts) %>% round(),
            tier = min(tier),
            points_vor = mean(points_vor) %>% round(),
            floor_vor = min(floor_vor) %>% round(),
            ceiling_vor = max(ceiling_vor) %>% round(),
            pos_ecr = mean(pos_ecr) %>% round(),
            sd_ecr = mean(sd_ecr) %>% round(),
            risk = mean(risk) %>% round(),
            adp = mean(adp) %>% round(),
            aav = max(1, mean(aav) %>% round())) %>% 
  left_join(predicted_yards_per_game, by = "id") %>%
  rename(points_adjustment = additional_points) %>% 
  group_by(position) %>% 
  mutate(
    points_adjustment = if_else(
      is.na(points_adjustment), 
      0, points_adjustment),
    points = if_else(
      is.na(points_adjustment), points,
      points + points_adjustment),
    pos_rank = rank(-points, ties.method="first")) %>% 
  ungroup() %>% 
  mutate(rank = rank(-points, ties.method="first"),
         points_per_game = (points / regular_season_games) %>% round(1),
         flex = if_else(position %in% c('RB','WR','TE'), TRUE, FALSE)) %>% 
  group_by(flex) %>% 
  mutate(flex_rank = rank(-points, ties.method="first")) %>% 
  ungroup() %>% 
  mutate(flex_rank = ifelse(flex, flex_rank, NA)) %>% 
  vorp_auction(target_points_week = target_points_week,
               budget = budget,
               dollar_vorp_target_override = dollar_vorp_target_override) %>% 
  select(id:sd_pts, 
         points_per_game, 
         tier, 
         pos_tier, 
         pos_ecr:rank, 
         flex_rank:max_bid) %>% 
  mutate(full_name = if_else(position == 'DST',
                             first_name,
                             paste0(first_name, " ", last_name))) %>% 
  left_join(yahoo_av, 
            by = c("full_name" = "player", "position" = "position", "team" = "team")) %>% 
  select(-full_name)

flex_rank_adj <- 
  projections %>% 
  filter((position %in% c('RB','WR') & pos_rank > 28) | (position == 'TE' & pos_rank > 14)) %>% 
  mutate(flex_rank_adj = rank(flex_rank, ties.method = "first")) %>% 
  select(id, flex_rank_adj)

projections <- 
  projections %>% 
  left_join(flex_rank_adj, by = "id")

write_csv(projections, 
          file.path(out, paste0("projections-", Sys.Date(), ".csv")))

write_csv(projections, 
          file.path(latest, "projections-latest.csv"))
```

```{r replacement_diff}
replacement_projected <-
  (projections %>%
     filter(position == 'QB' & pos_rank == 15)) %>%
  bind_rows((projections %>%
               filter(position == 'RB' & pos_rank == 29))) %>%
  bind_rows((projections %>%
               filter(position == 'WR' & pos_rank == 29))) %>%
  bind_rows((projections %>%
               filter(position == 'TE' & pos_rank == 15))) %>%
  bind_rows((projections %>%
               filter(position == 'K' & pos_rank == 15))) %>%
  bind_rows((projections %>%
               filter(position == 'DST' & pos_rank == 15))) %>%
  bind_rows((
    projections %>%
      filter(flex_rank_adj == 15) %>%
      select(-pos_rank) %>%
      rename(pos_rank = flex_rank_adj) %>%
      mutate(position = "FLX")
  )) %>%
  select(position, points) %>%
  rename(replacement_projected = points)

best_projected <-
  projections %>%
  filter(pos_rank == 1) %>%
  select(position, points) %>%
  bind_rows((
    projections %>%
      filter(!is.na(flex_rank) &
               ((pos_rank > 1 &
                   !(position %in% c("WR", "RB"))) |
                  (pos_rank > 2 & position %in% c("WR", "RB"))
               )) %>%
      arrange(flex_rank) %>%
      head(1) %>%
      mutate(position = "FLX") %>%
      select(position, points)
  )) %>%
  rename(best_projected = points)

replacement_diff <- 
  readr::read_csv(last_year_replacement_diff_file,
                  show_col_types = FALSE) %>% 
  full_join(best_projected, by = "position") %>% 
  full_join(replacement_projected, by = "position")

write_csv(replacement_diff, 
          file.path(out, paste0("replacement-diff-", Sys.Date(), ".csv")))

write_csv(replacement_diff, 
          file.path(latest, "replacement-diff-latest.csv"))
```

```{r write_to_gsheet}
gs4_auth(google_sheet_user)

projections %>% 
  googlesheets4::write_sheet(google_sheet_url,sheet = "projections")

replacement_diff %>% 
  googlesheets4::write_sheet(google_sheet_url,sheet = "replacement diff")
```